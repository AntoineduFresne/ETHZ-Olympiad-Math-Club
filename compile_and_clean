import os
import subprocess
import shutil

# Choose your LaTeX compiler (latexmk is safer if installed)
LATEX_CMD = ["latexmk", "-pdf", "-interaction=nonstopmode", "-halt-on-error"]

def compile_tex_to_pdf(tex_path):
    folder = os.path.dirname(tex_path)
    tex_name = os.path.basename(tex_path)
    try:
        subprocess.run(LATEX_CMD + [tex_name], cwd=folder, check=True)
    except subprocess.CalledProcessError:
        print(f"❌ Error compiling {tex_path}")

def clean_folder(folder):
    for root, dirs, files in os.walk(folder):
        for f in files:
            if not f.endswith(".pdf"):
                os.remove(os.path.join(root, f))

def main(root_folder):
    tex_files = []
    # Collect all .tex files
    for root, dirs, files in os.walk(root_folder):
        for f in files:
            if f.endswith(".tex"):
                tex_files.append(os.path.join(root, f))

    # Compile all
    for tex in tex_files:
        print(f"Compiling {tex}...")
        compile_tex_to_pdf(tex)

    # Clean up (remove everything except PDFs)
    clean_folder(root_folder)
    print("✅ Done. Only PDFs remain.")

if __name__ == "__main__":
    main("static/uploads/problems")